---
title: "Bernoulli Distribution (Example 7.18)"
number-sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE, comment=NA)
library(webexercises)
library(PASWR2)
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
```

```{=html}
<!-- question callout example
:::{.question}
::::{.question-header}
Question
::::
::::{.question-container}
This is where the question text would go.
::::
:::
-->
```
````{=html}
<!--
::: panel-tabset
## R Code
```{r, eval = FALSE}

```

## Output
```{r, echo = FALSE}

```
:::
-->
````

A laboratory is interested in testing a new child-friendly pesticide on *Blatta orientalis* (oriental cockroaches). The scientists from the lab apply the new pesticide to 81 randomly selected *Blatta orientalis oothecae* (eggs).

The results from the experiment are stored in the data frame `ROACHEGGS`, from the `PASWR2` package, in the variable `eggs`. A 0 indicates that nothing hatched from the egg, while a 1 indicates the birth of a cockroach.

Assuming the selected eggs are representative of the population of *Blatta orientalis* eggs, estimate the proportion of *Blatta orientalis* eggs that result in a birth, after being sprayed with the child-friendly pesticide.

**Solution**

We can start by reading in the data and saving it as an object called `eggs`.

::: panel-tabset
## R Code
```{r}
library(PASWR2)

eggs <- ROACHEGGS$eggs
```
:::


Whether or not a *Blatta orientalis* egg hatches is a Bernoulli trial with unknown parameter $\pi$. That is, $X\sim\mbox{Bernoulli}(\pi)$, where $X$ is the value 0, indicating that nothing hatched from the egg, or 1, indicating the birth of a cockroach.

We want to use the data from `ROACHEGGS`, as well as this Bernoulli distribution to find a **maximum likelihood estimate** for $\pi$, the probability that an egg hatches after being sprayed with the pesticide.

From the [Probability Formula Sheet](https://gla-my.sharepoint.com/:b:/g/personal/mitchum_bock_glasgow_ac_uk/EYMw7JaKJPhJqtx7U2y8014BpMoLnJ1iyb-ELxDb8hvGYg?e=BQm80L){target="_blank"} we see that the Bernoulli distribution has a probability distribution function (pdf) given by,

$$
P(X=x)=\pi^x(1-\pi)^{(1-x)}
$$

When $n$ samples are taken and the values $x_1, x_2, \ldots, x_n$ are observed (with each being either zero or one) we can write the likelihood function as,

$$
L(\pi|\mathbb{x})=\prod_{i=1}^n\pi^{x_i}(1-\pi)^{1-x_i}
$$ {#eq-like}

It will be easier to maximise the natural logarithm of the likelihood. Taking the natural logarithm of the likelihood function gives the log-likelihood function,

$$
\begin{align}
\ln L(\pi|\mathbb{x})&=\ln\left[\prod_{i=1}^n\pi^{x_i}(1-\pi)^{1-x_i}\right]\\
&=\sum_{i=1}^n\ln\left[\pi^x_i(1-\pi)^{1-x_i}\right]\\
&=\sum_{i=1}^n\left[x_i\ln\pi+(1-x_i)\ln(1-\pi)\right]\\
&=\ln\pi\sum_{i=1}^nx_i+\ln(1-\pi)\sum_{i=1}^n(1-x_i)
\end{align}
$$ {#eq-loglike}

The value that maximizes of this function will be our **maximum likelihood estimate**.

Using the following code and the data stored within the variable `eggs` as the various $x_i$ values, create a function in R called `loglike` to calculate the value of the above log-likelihood ([ -@eq-loglike]), for a given value of $\pi$.

::: panel-tabset
## R Code
```{r}
loglike <- function(pi){
  log(pi)*sum(eggs) + log(1 - pi)*sum(1 - eggs)
  }
```
:::

Using this new R function `loglike`, plot the log-likelihood ([ -@eq-loglike]), to see where the maximum value roughly lies using `ggplot2` as follows:

::: panel-tabset
## R Code
```{r, eval=FALSE, message=FALSE}
library(ggplot2)

ggplot(data.frame(x = c(0, 1)), aes(x = x)) +
  stat_function(fun = loglike, n = 200) +
  labs(x = expression(pi),
       y = "log-likelihood")
```

## Plots
```{r, echo=FALSE, message=FALSE}
library(ggplot2)

ggplot(data.frame(x = c(0, 1)), aes(x = x)) +
  stat_function(fun = loglike, n = 200) +
  labs(x = expression(pi),
       y = "log-likelihood")
```
:::

The code first creates a data frame which contains the range of values for $\pi$, $\left[0, 1\right]$, that we want to plot over. It then uses the layer `stat_function()` to calculate the value of the log-likelihood function ([ -@eq-loglike]) at 200 different points between 0 and 1. These values are automatically displayed as a line by `stat_function()`.

We can see from the above plot, that the maximum value of the log-likelihood function lies somewhere between 0.10 and 0.25. We can be more accurate than this however, and continue with the maximisation problem to find the **exact value at which the log-likelihood function is maximised**.

To find the value that **maximizes** this log-likelihood function, we need to take the first order derivative of $\ln L(\pi|\mathbb{x})$ with respect to $\pi$ and set the answer equal to 0. This then gives the equation,

$$
\begin{aligned}
\frac{\partial\ln L(\pi|\mathbb{x})}{\partial\pi}&=\frac{\sum_{i=1}^nx_i}{\pi}-\frac{\sum_{i=1}^n(1-x_i)}{(1-\pi)}=0
\end{aligned}
$$
that needs to be solved. The solution to this is given by $\pi=\frac{\sum_{i=1}^n}{n}=\bar x$ (try and show this yourself).

Our final step is to check that $\pi=\bar x$ indeed corresponds to a **maximum**. We can do this by checking that the second order derivative of the log-likelihood, with respect to $\pi$, is negative at $\pi=\bar x$. That is, $\frac{\partial^2\ln L(\pi|\mathbb{x})}{\partial\pi^2}<0$ when $\pi=\bar x$.

The second order derivative of the log-likelihood function is,

$$
\begin{aligned}
\frac{\partial^2\ln L(\pi|\mathbb{x})}{\partial\pi^2}&=\frac{-\sum_{i=1}^nx_i}{\pi^2}-\frac{n-\sum_{i=1}^nx_i}{(1-\pi)^2}
\end{aligned}
$$
The value of the second order derivative at $\pi=\bar x$ is then,

$$
\begin{aligned}
\frac{\partial^2\ln L(\pi|\mathbb{x})}{\partial\pi^2}&=\frac{-\sum_{i=1}^nx_i}{\bar x^2}-\frac{n-\sum_{i=1}^nx_i}{(1-\bar x)^2}\\
&=\frac{-n\bar x}{\bar x^2}-\frac{n-n\bar x}{(1-\bar x)^2}\\
&=\frac{-n}{\bar x}-\frac{n(1-\bar x)}{(1-\bar x)^2}\\
&=\frac{-n}{\bar x}-\frac{n}{(1-\bar x)}\\
&=\frac{-n}{\bar x(1-\bar x)}
\end{aligned}
$$
which is less than 0 since $0\leq\bar x\leq1$ and $n>0$. Since the values of the *likelihood* function ([ -@eq-like]) at the boundaries of the parameter space (i.e. when $\pi=0$ and $\pi=1$) are both 0, that is $L(\pi=0|\mathbb{x})=0$ and $L(\pi=1|\mathbb{x})=0$, then we can say that $\pi=\bar x$ is the value that **maximizes** the log-likelihood function (and hence, the value that maximizes the likelihood function).

We have now shown that the **maximum likelihood estimate** is $\hat\pi(\mathbb{x})=\bar x$. We can find the mean value from `eggs` which will be our estimate for the population proportion of eggs that hatch after being sprayed with the pesticide. Calculate the mean of `eggs` using the code below and verify that it is `r round(mean(eggs), 4)`.

::: panel-tabset
## R Code
```{r, eval=FALSE}
mean(eggs)
```

## Output
```{r, echo=FALSE}
mean(eggs)
```
:::

Add this value to the plot we made above, to show visually that this is indeed the maximum value. To do this, the code for the plot is exactly the same as above, but now the layer `geom_vline()` has been used to add a `"dashed"` vertical line at `r round(mean(eggs), 4)`.

::: panel-tabset
## R Code
```{r, eval=FALSE}
ggplot(data.frame(x = c(0, 1)), aes(x = x)) +
  stat_function(fun = loglike, n = 200) +
  labs(x = expression(pi),
       y = "log-likelihood") +
  geom_vline(xintercept = mean(eggs), lty = "dashed")
```

## Plots
```{r, echo=FALSE}
ggplot(data.frame(x = c(0, 1)), aes(x = x)) +
  stat_function(fun = loglike, n = 200) +
  labs(x = expression(pi),
       y = "log-likelihood") +
  geom_vline(xintercept = mean(eggs), lty = "dashed")
```
:::

After having defined the function `loglike`, which calculates the value of the log-likelihood of a Bernoulli distribution at a given value of $\pi$, we could use the R function `optimize()` to find the maximum of the function. The arguments that `optimize()` can take are,

* `f =`: the function for which the maximum (or minimum) value should be found.
* `interval =`: the interval across which the maximum (or minimum) value should be found.
* `maximum =`: a `TRUE` or `FALSE` statement indicating whether the maximum or minimum should be found. By default, the minimum value will be found.

Find the value of the maximum likelihood estimator for the proportion of cockroach eggs which hatch after being sprayed with the pesticide as follows:

::: panel-tabset
## R Code
```{r, eval=FALSE}
optimize(f = loglike, interval = c(0, 1), maximum = TRUE)
```

## Output
```{r, echo=FALSE}
optimize(f = loglike, interval = c(0, 1), maximum = TRUE)
```
:::

Here, we have set `interval =` to be the range $[0,1]$, because $\pi$ is a probability so it has to lie in the range $[0,1]$. `optimize()` returns two values; `maximum` which is the value of $\pi$ which maximises the log-likelihood function, and `objective` which is the value of the log-likelihood function at this value of $\pi$.

Note that the value of `maximum` returned here, `r round(mean(eggs), 4)`, is in agreement with the maximum likelihood estimate we found above ($\hat\pi(\mathbb{x})=\bar x=`r round(mean(eggs), 4)`$).

Another function we could have used to solve this problem is the `nlm()` function. This will only search for the **minimum** of a function (not a maximum), so in order to use it to find the maximum of the log-likelihood function, we should input the negative of the log-likelihood. We can create this in a new function called `negloglike` as follows. Note that this makes use of our predefined function, `loglike`.

::: panel-tabset
## R Code
```{r}
negloglike <- function(pi){
  (-1)*loglike(pi)
}
```
:::

Now we are ready to use the `nlm()` function. The arguments this can take are,

* `f =`: this is the function for which the minimum value should be found.
* `p =`: this is the starting parameter value to use to find the minimum. `nlm()` will work iteratively to find the minimum of the function.

Find the minimum of `negloglike` as follows:

::: panel-tabset
## R Code
```{r, eval=FALSE, warning=FALSE}
nlm(f = negloglike, p = 0.2)
```

## Output
```{r, echo=FALSE, warning=FALSE}
nlm(f = negloglike, p = 0.2)
```
:::

The value we are interested in here is `estimate` which we can extract.

::: panel-tabset
## R Code
```{r, eval=FALSE, warning=FALSE}
nlm(f = negloglike, p = 0.2)$estimate
```

## Output
```{r, echo=FALSE, warning=FALSE}
nlm(f = negloglike, p = 0.2)$estimate
```
:::

Again, this value is in agreement with the $\bar x=`r round(mean(eggs), 4)`$ being the **maximum likelihood estimate**. Note that `nlm()` has identified `r round(mean(eggs), 4)` as being the value of $\pi$ which *minimises* the *negative* of the log-likelihood, but this is equivalent to it being the value which *maximises* the log-likelihood.


---

You can find more examples of finding maximum likelihood estimators, both 'by hand' and using R in [Section 7.3.2 Likelihood and Maximum Likelihood Estimators](https://read.kortext.com/reader/pdf/92741/419){target="_blank"} of *Probability and Statistics with R*.





