```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE, comment=NA)
library(webexercises)
library(PASWR2)
library(knitr)
library(kableExtra)
library(ggplot2)
library(tidyverse)
```

# Merging data frames {#sec-merge}

```{r read1, echo = FALSE}
chol <- read.table(file = "Data/chol.txt", header = TRUE, fileEncoding = 'UTF-8-BOM')
chol$gender <- factor(x = chol$gender, levels = c("female", "male"))
chol$smoke <- factor(x = chol$smoke, levels = c("no", "ex-smoker", "current"))
measurements <- read.csv(file = "Data/measurements.csv", fileEncoding = 'UTF-8-BOM')
chol_full <- cbind(chol, measurements)
chol_full$bmi <- chol_full$weight/(chol_full$height)^2
subject <- data.frame(id = "P461", ldl = 148, hdl = 78, trig = 120, age = 41, gender = "male", smoke = "current",
                      weight = 84.05, height = 1.79)
subject$bmi <- subject$weight/(subject$height)^2
chol_full <- rbind(chol_full, subject)
```

```{r read2, echo = FALSE}
education <- read.csv(file = "Data/edu.csv", na.strings = "*", fileEncoding = 'UTF-8-BOM')
education$year <- factor(x = education$year, levels = c("2016", "2017", "2018", "2019", "2020", "2021", "2022"))
education$level <- factor(x = education$level, levels = c("ELC", "Primary", "Secondary"))
education$ratio <- education$pupils/education$teachers
```


Sometimes information relating to the same subjects or observations might be stored in two separate data frames. When this is the case it is easy to combine two data frames using the `merge()` function. `merge()` takes the following arguments:

* `x =`: this is the first of the two data frames you want to merge together.
* `y =`: this is the second of the two data frames you want to merge.
* `by.x =`: this specifies which column in the first data frame should be used to merge. This is usually an identifying variable such as subjects' names or ID codes.
* `by.y =`: this specifies which column in the second data frame should be used to merge.
* `all =`: this takes values `TRUE` or `FALSE`, indicating whether all rows from both data frames should be included.
* `all.x =`: this takes values `TRUE` and `FALSE`, indicating whether extra rows should be created in the second data frame so that all rows in the first data frame are kept.
* `all.y =`: this takes values `TRUE` and `FALSE`, indicating whether extra rows should be created in the first data frame so that all rows in the second data frame are kept.

Only the arguments `x =` and `y =` are required. When any of of the `by. =` arguments are left out of the function, R will automatically look for columns which share the same name in the two data sets. When any of the `all. =` arguments are left out, they default to `FALSE`, so only complete cases are kept in the final merged data frame.

The file *treatment.csv* contains information on whether patients in a study testing a new treatment for high cholesterol were given the new drug or a placebo drug with no effect. Some of the patients in this new study are subjects from the `chol` data frame. We can read in the file *treatment.csv* and merge it with `chol_full` in order to see all the information available on a subject.

To start with, we need to read in *treatment.csv* and save this as a data frame called `treatment`.

::: panel-tabset
## R Code
```{r data30, echo=FALSE}
treatment <- read.csv(file = "Data/treatment.csv", fileEncoding = 'UTF-8-BOM')
```

```{r data31, eval=FALSE}
treatment <- read.csv(file = "treatment.csv")
```
:::

Then we can merge `chol_full` and `treatment` into a single data frame called `patients` using the following code.

::: panel-tabset
## R Code
```{r data32.1, eval = FALSE}
patients <- merge(x = chol_full, y = treatment, by.x = "id",
                  by.y = "patient_id", all = TRUE)
head(patients[, -c(1:3)])
```

## Ouptut
```{r data32.2, echo = FALSE}
patients <- merge(x = chol_full, y = treatment, by.x = "id", by.y = "patient_id",
                  all = TRUE)
head(patients[, -c(1:3)])
```
:::

Because the column showing the patient ID has a different name in `chol_full` and `treatment`, we have had to specify what it is called in each data frame here using `by.x =` and `by.y =` (make sure to check the contents of your data frames to notice things like this!). The argument `all = TRUE` means that we are keeping all information from both data frames, regardless of whether a patient only appears in `chol_full` or only in `treatment`. This is why in the excerpt of `patients` above, there are rows where the value for all variables except `treatment` are `NA`.

:::{.question}
::::{.question-header}
Task
::::
::::{.question-container}
The file *class.csv* contains information on the average primary class size in the years 2016 - 2022. Read this file into R and save it as a data frame called `class`.

Merge the information from the data frames `education` and `class` together into a new data frame called `primary`, showing all variables from `education` and the average class size for primary schools only. Look carefully at which row names these two data frames have in common.

`r hide("Solution")`
```{r data-ans12.1, echo=FALSE}
class <- read.csv(file = "Data/class.csv", fileEncoding = 'UTF-8-BOM')
primary <- merge(x = education, y = class, by = c("year", "level"), all.y = TRUE)
```

To read the file *class.csv* in to R, we can use the following code.

::: panel-tabset
## R Code
```{r data-ans12.2, eval=FALSE}
class <- read.csv(file = "class.csv")
```
:::

In order to merge the two data frames, we want to use the function `merge()`. The data frame we provide to the argument `x =` is `education` and the data frame for the `y =` argument is `class`. 

Because we want to match up the rows with the same year and the same level of education, we need to give the argument `by =` a vector of these two variables. We can use the argument `by =`, rather than `by.x =` and `by.y =`, because the columns have the same names in both data frames.

Finally, since we only want to show the rows for primary schools, we can specify `all.y =TRUE`. This will keep all the rows from the second data frame, `class`, and delete the rows from the first data frame which don't have a matching row in the second. For example, because there is no information on the average class size in secondary schools in 2016 in `class`, this row from `education` will not appear in `primary`.

::: panel-tabset
## R Code
```{r data-ans12.3, eval = FALSE}
primary <- merge(x = education, y = class, by = c("year", "level"), 
                 all.y = TRUE)
primary
```

## Ouptut
```{r data-ans12.4, echo = FALSE}
primary
```
:::
`r unhide()`
::::
:::

---

For more information on merging data set, see **Section 1.11.4 Merging Data Frames** of *Probability and Statistics with R*.
